<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Retirement Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); padding: 24px; margin-bottom: 20px; }
        .input-group label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 4px; }
        .input-group input, .input-group select { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; }
        .input-group input:focus { outline: none; border-color: #3b82f6; ring: 2px #3b82f6; }
        .input-group input[readonly] { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; }
        .btn-primary { background-color: #f7931a; color: white; font-weight: 600; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; transition: background 0.2s; width: 100%; }
        .btn-primary:hover { background-color: #e68b15; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; font-weight: 600; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.8rem; transition: background 0.2s; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .stat-card { background: #f9fafb; border-radius: 8px; padding: 16px; text-align: center; border: 1px solid #e5e7eb; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: #111827; }
        .stat-label { font-size: 0.8rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background-color: #f3f4f6; padding: 10px; text-align: right; font-weight: 600; color: #374151; position: sticky; top: 0; white-space: nowrap; }
        td { padding: 8px 10px; text-align: right; border-bottom: 1px solid #e5e7eb; }
        tr:last-child td { border-bottom: none; }
        
        /* Scenario Colors */
        .sc-ex-unlucky { color: #7f1d1d; }
        .sc-unlucky { color: #dc2626; }
        .sc-semi-unlucky { color: #d97706; }
        .sc-median { color: #2563eb; }
        .sc-semi-lucky { color: #7c3aed; }
        .sc-lucky { color: #059669; }

        .tab-btn { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; color: #6b7280; }
        .tab-btn.active { color: #f7931a; border-bottom-color: #f7931a; }
        
        .tooltip { position: relative; display: inline-block; cursor: help; margin-left: 4px; color: #9ca3af; }
        .tooltip:hover::after { content: attr(data-tip); position: absolute; left: 50%; bottom: 100%; transform: translateX(-50%); background: #374151; color: white; padding: 6px 10px; border-radius: 4px; font-size: 0.75rem; width: 200px; z-index: 10; margin-bottom: 5px; }
        
        .checkbox-wrapper { display: flex; align-items: center; margin-right: 12px; cursor: pointer; font-size: 0.85rem; user-select: none; }
        .checkbox-wrapper input { margin-right: 6px; accent-color: currentColor; }

        .calc-result-box { border-left: 4px solid #3b82f6; background-color: #eff6ff; padding: 16px; border-radius: 4px; margin-top: 20px; }
        .action-highlight { font-weight: 700; color: #1e40af; font-size: 1.1rem; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Bitcoin Retirement Simulator</h1>
        <p class="text-gray-600 mb-8">Monte Carlo simulation of volatility harvesting and dynamic withdrawal strategies.</p>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-1 space-y-4">
                
                <!-- Strategy Selection -->
                <div class="card border-l-4 border-orange-500">
                    <h2 class="text-lg font-bold mb-4 text-gray-900">1. Strategy Logic</h2>
                    <div class="input-group">
                        <label>Rebalancing Strategy</label>
                        <select id="strategyType" onchange="updateStrategyDesc(); updateCalculator();">
                            <option value="match_pension">Monthly: Match Pension (Recommended)</option>
                            <option value="skim_1_5">Monthly: Skim 1.5% on Up Months</option>
                            <option value="annual_10">Annual: Sell 10% after Good Year</option>
                            <option value="simple">Simple: No Buffer Refill</option>
                        </select>
                    </div>
                    
                    <div id="strategyDescription" class="text-xs text-gray-600 mt-2 p-3 bg-orange-50 rounded border border-orange-100"></div>

                    <div class="input-group mt-3">
                        <label>Withdrawal Rule</label>
                        <select id="withdrawalRule" onchange="updateWithdrawalDesc(); updateCalculator();">
                            <option value="hybrid_floor">Hybrid (Lower of Ideal vs Cap, but > Floor)</option>
                            <option value="strict_cap">Strict Cap (Never exceed % of BTC)</option>
                            <option value="fixed">Fixed Target (Ignore Portfolio Value)</option>
                        </select>
                    </div>

                    <div id="withdrawalDescription" class="text-xs text-gray-600 mt-2 p-3 bg-blue-50 rounded border border-blue-100"></div>

                    <div class="flex items-center mt-4">
                        <input type="checkbox" id="inflationFreeze" class="w-4 h-4 text-orange-500 rounded" checked onchange="updateCalculator()">
                        <label for="inflationFreeze" class="ml-2 text-sm text-gray-700 font-medium cursor-pointer">
                            Freeze Inflation if Buffer < <span id="freezeLabel">500k</span>
                        </label>
                    </div>
                </div>

                <!-- Accumulation Phase -->
                <div class="card">
                    <h2 class="text-lg font-bold mb-4 text-gray-900">2. Current State (2025)</h2>
                    
                    <div class="bg-gray-50 p-3 rounded mb-4 border border-gray-200">
                        <div class="flex justify-between items-end mb-2">
                            <label class="text-xs font-bold text-gray-500 uppercase">Bitcoin Holdings</label>
                            <button class="btn-secondary text-xs py-1 px-2" onclick="fetchBtcPrice()">
                                ⚡ Fetch Live Price
                            </button>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="btcAmount" placeholder="Amount (e.g. 2.5)" value="2.5" class="w-full border-gray-300 rounded" oninput="recalcBtcValue()">
                            <span class="flex items-center text-sm font-bold text-gray-600">BTC</span>
                        </div>
                        <div id="priceDisplay" class="text-xs text-gray-500 text-right h-4"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="input-group">
                            <label>Current BTC Value (PLN)</label>
                            <input type="number" id="startBtc" value="1000000" oninput="updateBtcAmountFromValue()"> 
                        </div>
                        <div class="input-group">
                            <label>Current Cash (PLN)</label>
                            <input type="number" id="startCash" value="200000">
                        </div>
                        <div class="input-group">
                            <label>Retirement Year</label>
                            <input type="number" id="retirementYear" value="2030" oninput="updateAccumYears()">
                        </div>
                        <div class="input-group">
                            <label>Accum. Years <span class="tooltip" data-tip="Years between 2025 and Retirement">?</span></label>
                            <input type="number" id="accumYears" value="5" readonly>
                        </div>
                        <div class="input-group col-span-2">
                            <label>Pre-Retirement CAGR</label>
                            <input type="number" id="preCagr" value="0.25" step="0.01">
                        </div>
                    </div>
                </div>

                <!-- Distribution Phase -->
                <div class="card">
                    <h2 class="text-lg font-bold mb-4 text-gray-900">3. Retirement Phase</h2>
                    
                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-2 mt-4">Market Assumptions</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="input-group">
                            <label>Base CAGR (Start)</label>
                            <input type="number" id="baseCagr" value="0.25" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>CAGR Decay <span class="tooltip" data-tip="Multiplies CAGR by this factor annually.">?</span></label>
                            <input type="number" id="decay" value="0.95" step="0.01">
                        </div>
                        <div class="input-group">
                            <label>Base Volatility (Ann.)</label>
                            <input type="number" id="volatility" value="0.60" step="0.05">
                        </div>
                        <div class="input-group">
                            <label>Vol. Decay <span class="tooltip" data-tip="Multiplies Volatility by this factor annually. E.g. 0.9 decreases vol over time.">?</span></label>
                            <input type="number" id="volDecay" value="0.9" step="0.01">
                        </div>
                        <div class="input-group col-span-2">
                            <label>Cash Interest</label>
                            <input type="number" id="cashInterest" value="0.03" step="0.01">
                        </div>
                    </div>

                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-2 mt-4">Pension Goals</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="input-group">
                            <label>Floor Monthly</label>
                            <input type="number" id="floorPension" value="10000" oninput="updateCalculator()">
                        </div>
                        <div class="input-group">
                            <label>Ideal Monthly</label>
                            <input type="number" id="idealPension" value="15000" oninput="updateCalculator()">
                        </div>
                        <div class="input-group">
                            <label>Yearly Inflation</label>
                            <input type="number" id="pensionGrowth" value="0.05" step="0.01" oninput="updateCalculator()">
                        </div>
                        <div class="input-group">
                            <label>Safe Cap % (Monthly)</label>
                            <input type="number" id="safeCapPct" value="0.005" step="0.001" oninput="updateCalculator()">
                        </div>
                    </div>
                    
                    <div class="input-group mt-3">
                        <label>Freeze Threshold (PLN)</label>
                        <input type="number" id="freezeThreshold" value="500000">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="input-group">
                        <label>Duration (Years)</label>
                        <input type="number" id="simYears" value="10">
                    </div>
                    <div class="input-group">
                        <label>Num. Simulations</label>
                        <input type="number" id="nSims" value="1000" step="1000" max="100000">
                    </div>
                </div>

                <button class="btn-primary mt-4" onclick="runSimulation()">Run Simulation</button>
            </div>

            <!-- Right Column: Results -->
            <div class="lg:col-span-2">
                
                <!-- KPI Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="stat-card">
                        <div class="stat-value text-green-600" id="statSurvival">--%</div>
                        <div class="stat-label">Survival Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value text-blue-600" id="statMedianWealth">--x</div>
                        <div class="stat-label">Median Wealth Mult.</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value text-orange-600" id="statFloorHit">--%</div>
                        <div class="stat-label">Floor Pension Freq.</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value text-gray-600" id="statUnluckyWealth">--</div>
                        <div class="stat-label">Unlucky Outcome (PLN)</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="card">
                    <div class="flex items-center justify-between border-b border-gray-200 mb-4">
                        <div class="flex">
                            <div class="tab-btn active" onclick="switchTab('wealth')">Total Capital</div>
                            <div class="tab-btn" onclick="switchTab('pension')">Monthly Pension</div>
                            <div class="tab-btn" onclick="switchTab('buffer')">Cash Buffer</div>
                        </div>
                    </div>
                    
                    <!-- Chart Visibility Controls -->
                    <div class="flex flex-wrap gap-2 mb-3 justify-center text-xs">
                        <label class="checkbox-wrapper sc-ex-unlucky font-bold"><input type="checkbox" id="chartShowExUnlucky" onchange="updateChartVisibility()" checked> Extreme (5%)</label>
                        <label class="checkbox-wrapper sc-unlucky font-bold"><input type="checkbox" id="chartShowUnlucky" onchange="updateChartVisibility()" checked> Unlucky (10%)</label>
                        <label class="checkbox-wrapper sc-semi-unlucky font-bold"><input type="checkbox" id="chartShowSemiUnlucky" onchange="updateChartVisibility()"> Semi-Un (30%)</label>
                        <label class="checkbox-wrapper sc-median font-bold"><input type="checkbox" id="chartShowMedian" onchange="updateChartVisibility()" checked> Median (50%)</label>
                        <label class="checkbox-wrapper sc-semi-lucky font-bold"><input type="checkbox" id="chartShowSemiLucky" onchange="updateChartVisibility()"> Semi-Lu (70%)</label>
                        <label class="checkbox-wrapper sc-lucky font-bold"><input type="checkbox" id="chartShowLucky" onchange="updateChartVisibility()" checked> Lucky (90%)</label>
                    </div>

                    <div style="height: 300px;">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <!-- Detailed Table -->
                <div class="card overflow-x-auto">
                    <h3 class="text-lg font-bold mb-2 text-gray-900">Yearly Breakdown</h3>
                    
                    <!-- Table Toggle Controls -->
                    <div class="flex flex-wrap gap-2 mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <label class="checkbox-wrapper sc-ex-unlucky font-semibold"><input type="checkbox" id="showExUnlucky" onchange="renderTable()"> Extreme (5%)</label>
                        <label class="checkbox-wrapper sc-unlucky font-semibold"><input type="checkbox" id="showUnlucky" onchange="renderTable()" checked> Unlucky (10%)</label>
                        <label class="checkbox-wrapper sc-semi-unlucky font-semibold"><input type="checkbox" id="showSemiUnlucky" onchange="renderTable()"> Semi-Unlucky (30%)</label>
                        <label class="checkbox-wrapper sc-median font-semibold"><input type="checkbox" id="showMedian" onchange="renderTable()" checked> Median (50%)</label>
                        <label class="checkbox-wrapper sc-semi-lucky font-semibold"><input type="checkbox" id="showSemiLucky" onchange="renderTable()"> Semi-Lucky (70%)</label>
                        <label class="checkbox-wrapper sc-lucky font-semibold"><input type="checkbox" id="showLucky" onchange="renderTable()"> Lucky (90%)</label>
                    </div>

                    <table id="resultsTable">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- ACTION CALCULATOR -->
                <div class="card border border-blue-200 bg-white">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm">Now</span>
                        Monthly Action Calculator
                    </h2>
                    <p class="text-sm text-gray-500 mb-4">Enter your current real-time stats to get a specific instruction based on the chosen strategy.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div class="input-group">
                            <label>Current Year</label>
                            <input type="number" id="calcYear" value="2030" oninput="updateCalculator()">
                        </div>
                        <div class="input-group">
                            <label>Current BTC Value (PLN)</label>
                            <input type="number" id="calcBtc" value="2500000" oninput="updateCalculator()">
                        </div>
                        <div class="input-group">
                            <label>Current Buffer (PLN)</label>
                            <input type="number" id="calcBuffer" value="250000" oninput="updateCalculator()">
                        </div>
                        <div class="input-group">
                            <label>BTC Return This Month (%)</label>
                            <input type="number" id="calcReturn" value="5.0" step="0.1" oninput="updateCalculator()">
                        </div>
                    </div>
                    
                    <button class="btn-primary mb-4 bg-blue-600 hover:bg-blue-700" onclick="updateCalculator()">Calculate Action</button>

                    <div id="calcResult" class="calc-result-box hidden"></div>
                </div>

            </div>
        </div>
    </div>

<script>
    // --- Helper: Safe Element Getter ---
    function getVal(id, def = 0) {
        const el = document.getElementById(id);
        if (!el) return def;
        const val = parseFloat(el.value);
        return isNaN(val) ? def : val;
    }

    // --- STRATEGY DEFINITIONS ---
    const Strategies = {
        'match_pension': {
            onMonth: (isPositive, targetPension, btcVal, cashVal) => {
                let paidFromBtc = 0, paidFromCash = 0, skim = 0;
                if (isPositive) {
                    paidFromBtc = targetPension;
                    skim = targetPension; 
                } else {
                    if (cashVal >= targetPension) paidFromCash = targetPension;
                    else { paidFromCash = cashVal; paidFromBtc = targetPension - cashVal; }
                }
                return { paidFromBtc, paidFromCash, skim };
            },
            onYear: (prevYearReturn, btcVal) => 0
        },
        'skim_1_5': {
            onMonth: (isPositive, targetPension, btcVal, cashVal) => {
                let paidFromBtc = 0, paidFromCash = 0, skim = 0;
                if (isPositive) {
                    paidFromBtc = targetPension;
                    skim = btcVal * 0.015;
                } else {
                    if (cashVal >= targetPension) paidFromCash = targetPension;
                    else { paidFromCash = cashVal; paidFromBtc = targetPension - cashVal; }
                }
                return { paidFromBtc, paidFromCash, skim };
            },
            onYear: (prevYearReturn, btcVal) => 0
        },
        'annual_10': {
            onMonth: (isPositive, targetPension, btcVal, cashVal) => {
                let paidFromBtc = 0, paidFromCash = 0, skim = 0;
                if (isPositive) paidFromBtc = targetPension;
                else {
                    if (cashVal >= targetPension) paidFromCash = targetPension;
                    else { paidFromCash = cashVal; paidFromBtc = targetPension - cashVal; }
                }
                return { paidFromBtc, paidFromCash, skim };
            },
            onYear: (prevYearReturn, btcVal) => (prevYearReturn > 0) ? btcVal * 0.10 : 0
        },
        'simple': {
            onMonth: (isPositive, targetPension, btcVal, cashVal) => {
                let paidFromBtc = 0, paidFromCash = 0, skim = 0;
                if (isPositive) paidFromBtc = targetPension;
                else {
                    if (cashVal >= targetPension) paidFromCash = targetPension;
                    else { paidFromCash = cashVal; paidFromBtc = targetPension - cashVal; }
                }
                return { paidFromBtc, paidFromCash, skim };
            },
            onYear: (prevYearReturn, btcVal) => 0
        }
    };

    const WithdrawalRules = {
        'fixed': (floor, ideal, cap) => ideal,
        'strict_cap': (floor, ideal, cap) => cap,
        'hybrid_floor': (floor, ideal, cap) => Math.max(floor, Math.min(ideal, cap))
    };

    // --- Global State ---
    let chartInstance = null;
    let globalTableData = null; 
    let globalSimResults = null; 
    let globalInputs = null;
    let currentBtcPricePln = 0;

    // --- UI Info ---
    const strategyInfo = {
        'match_pension': { desc: "<strong>Logic:</strong> On positive months, sell 2x pension amount (1x for living, 1x to buffer). On negative months, pay from buffer.", ex: "<strong>Example:</strong> Pension 10k. BTC Up? Sell 20k BTC (10k pocket, 10k buffer). BTC Down? Sell 0 BTC, take 10k from Buffer." },
        'skim_1_5': { desc: "<strong>Logic:</strong> On positive months, sell pension amount + 1.5% of total Bitcoin holdings to buffer. On negative months, pay from buffer.", ex: "<strong>Example:</strong> Portfolio 1M. Pension 10k. BTC Up? Sell 10k (pension) + 15k (1.5% skim) to Buffer." },
        'annual_10': { desc: "<strong>Logic:</strong> Once a year (Jan), if previous year was positive, sell 10% of Bitcoin holdings to buffer. Monthly payments come from Buffer if BTC is down.", ex: "<strong>Example:</strong> Jan 1st, BTC holding 1M. Last year up? Sell 100k to Buffer." },
        'simple': { desc: "<strong>Logic:</strong> Standard withdrawal. Pay from Buffer only when Bitcoin drops to avoid selling low. No proactive profit taking.", ex: "<strong>Example:</strong> BTC Down? Use cash. BTC Up? Sell BTC for pension." }
    };

    const withdrawalInfo = {
        'hybrid_floor': { desc: "<strong>Logic:</strong> Flexible withdrawal. Calculate Safe Cap (0.5% of BTC). If Cap is between Floor and Ideal, take Cap. If Cap > Ideal, take Ideal (save remainder). If Cap < Floor, take Floor (subsidized by Buffer).", ex: "<strong>Example:</strong> Floor 10k, Ideal 15k. <br>• Cap = 8k? Take 10k (Buffer covers 2k).<br>• Cap = 12k? Take 12k.<br>• Cap = 20k? Take 15k." },
        'strict_cap': { desc: "<strong>Logic:</strong> Rigid safety. Always take exactly the Safe Cap % (e.g. 0.5% of BTC). No floor protection.", ex: "<strong>Example:</strong> BTC drops to 1M? Pension is 5k. BTC rises to 4M? Pension is 20k. Income fluctuates wildly." },
        'fixed': { desc: "<strong>Logic:</strong> Rigid lifestyle. Always take the Ideal Pension amount adjusted for inflation, regardless of portfolio performance.", ex: "<strong>Example:</strong> Ideal 15k. BTC crashes? Still take 15k. High risk of depleting capital early." }
    };

    function updateStrategyDesc() {
        const val = document.getElementById('strategyType').value;
        const info = strategyInfo[val];
        document.getElementById('strategyDescription').innerHTML = `${info.desc}<br><div class="mt-1 text-gray-500">${info.ex}</div>`;
    }

    function updateWithdrawalDesc() {
        const val = document.getElementById('withdrawalRule').value;
        const info = withdrawalInfo[val];
        document.getElementById('withdrawalDescription').innerHTML = `${info.desc}<br><div class="mt-1 text-gray-500">${info.ex}</div>`;
    }

    async function fetchBtcPrice() {
        const display = document.getElementById('priceDisplay');
        display.innerHTML = '<span class="text-blue-500">Fetching...</span>';
        try {
            const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=pln,usd');
            const data = await response.json();
            if (data.bitcoin) {
                currentBtcPricePln = data.bitcoin.pln;
                const usd = data.bitcoin.usd;
                const fmt = (n, curr) => new Intl.NumberFormat('en-US', { style: 'currency', currency: curr }).format(n);
                display.innerHTML = `1 BTC = <strong>${fmt(currentBtcPricePln, 'PLN')}</strong> / ${fmt(usd, 'USD')}`;
                recalcBtcValue();
            } else { display.innerHTML = '<span class="text-red-500">Error.</span>'; }
        } catch (e) { display.innerHTML = '<span class="text-red-500">API Error.</span>'; }
    }

    function recalcBtcValue() {
        if (currentBtcPricePln > 0) {
            const amount = getVal('btcAmount');
            document.getElementById('startBtc').value = Math.round(amount * currentBtcPricePln);
        }
    }

    function updateBtcAmountFromValue() {
        if (currentBtcPricePln > 0) {
            const val = getVal('startBtc');
            document.getElementById('btcAmount').value = (val / currentBtcPricePln).toFixed(4);
        }
    }

    function updateAccumYears() {
        const retirement = getVal('retirementYear', 2030);
        const current = 2025;
        document.getElementById('accumYears').value = Math.max(0, retirement - current);
        document.getElementById('calcYear').value = retirement;
        updateCalculator();
    }

    // --- Action Calculator ---
    function updateCalculator() {
        const currentYear = getVal('calcYear');
        const currentBtc = getVal('calcBtc');
        const currentBuffer = getVal('calcBuffer');
        const monthlyReturn = getVal('calcReturn');
        
        const stratKey = document.getElementById('strategyType').value;
        const ruleKey = document.getElementById('withdrawalRule').value;
        
        const startYear = getVal('retirementYear', 2030);
        const yearsPassed = Math.max(0, currentYear - startYear);
        const growthRate = getVal('pensionGrowth');
        const baseFloor = getVal('floorPension');
        const baseIdeal = getVal('idealPension');
        const wRatePct = getVal('safeCapPct');
        const preCagr = getVal('preCagr'); // Assuming simple Pre-CAGR projection for target
        
        const inflationFactor = Math.pow(1 + growthRate, yearsPassed);
        const targetFloor = baseFloor * inflationFactor;
        const targetIdeal = baseIdeal * inflationFactor;
        const safeCap = currentBtc * wRatePct;
        
        const ruleFunc = WithdrawalRules[ruleKey];
        const actualPension = ruleFunc(targetFloor, targetIdeal, safeCap);
        
        const stratFunc = Strategies[stratKey].onMonth;
        const isPositive = monthlyReturn > 0;
        
        const result = stratFunc(isPositive, actualPension, currentBtc, currentBuffer);
        
        let message = "";
        let sellBtc = result.paidFromBtc + result.skim; 
        let drainBuffer = result.paidFromCash;
        let addToBuffer = result.skim;
        
        if (isPositive) {
            if (addToBuffer > 0) message = "Bitcoin is UP. Paying pension from BTC profits and skimming extra to Buffer.";
            else message = "Bitcoin is UP. Selling BTC to pay pension.";
        } else {
            if (drainBuffer > 0 && sellBtc === 0) message = "Bitcoin is DOWN. Preserving BTC. Paying from Buffer.";
            else if (drainBuffer > 0 && sellBtc > 0) message = "Bitcoin is DOWN. Buffer insufficient! Draining buffer and selling BTC for remainder.";
            else message = "Bitcoin is DOWN. Paying from BTC (Buffer empty/unused).";
        }

        const fmt = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'PLN', maximumFractionDigits: 0 }).format(n);
        
        // Calculate Target Price in Retirement Year
        // Logic: Live Price * (1 + PreCagr)^(Retirement - 2025)
        // If live price not available, show nothing or calc based on current input?
        // Let's use currentBtcPricePln if available
        
        let contextHtml = "";
        if (currentBtcPricePln > 0) {
            const retYear = getVal('retirementYear', 2030);
            const currentYearDate = new Date().getFullYear(); // ~2025
            const yearsToRet = Math.max(0, retYear - 2025);
            const projPrice = currentBtcPricePln * Math.pow(1 + preCagr, yearsToRet);
            
            contextHtml = `
            <div class="mt-3 pt-3 border-t border-blue-200 text-xs text-blue-800 flex justify-between">
                <div>Live 1 BTC: <strong>${fmt(currentBtcPricePln)}</strong></div>
                <div>Target 1 BTC (${retYear}): <strong>${fmt(projPrice)}</strong></div>
            </div>`;
        }

        const html = `
            <div class="mb-4">
                <div class="flex items-center justify-between">
                     <div class="text-sm font-bold text-gray-500 uppercase">Calculated Pension Target</div>
                     <div class="text-xs font-semibold text-blue-600">Safe Cap: ${fmt(safeCap)}</div>
                </div>
                <div class="text-2xl font-bold text-gray-900">${fmt(actualPension)}</div>
                <div class="text-xs text-gray-500">Floor ${fmt(targetFloor)} / Ideal ${fmt(targetIdeal)}</div>
            </div>
            <div class="p-3 bg-white border border-blue-200 rounded mb-3">
                <div class="text-sm font-bold text-blue-800 mb-1">INSTRUCTION:</div>
                <div class="text-gray-800 text-sm mb-2">${message}</div>
                <ul class="list-disc list-inside text-sm text-gray-700">
                    <li><strong>Sell Bitcoin:</strong> ${fmt(sellBtc)}</li>
                    <li><strong>Withdraw from Buffer:</strong> ${fmt(drainBuffer)}</li>
                    <li><strong>Add to Buffer:</strong> ${fmt(addToBuffer)}</li>
                    <li><strong>Net to Pocket:</strong> ${fmt(actualPension)}</li>
                </ul>
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm bg-gray-50 p-2 rounded">
                <div><span class="block text-gray-500">New BTC Balance</span><span class="font-bold">${fmt(currentBtc - sellBtc)}</span></div>
                <div><span class="block text-gray-500">New Cash Buffer</span><span class="font-bold">${fmt(currentBuffer - drainBuffer + addToBuffer)}</span></div>
            </div>
            ${contextHtml}
        `;
        
        const resBox = document.getElementById('calcResult');
        if (resBox) {
             resBox.innerHTML = html;
             resBox.classList.remove('hidden');
        }
    }

    // --- Main Simulation ---
    function runSimulation() {
        const nSimsEl = document.getElementById('nSims');
        const nSimsInput = nSimsEl ? parseInt(nSimsEl.value) : 1000;
        const nSims = isNaN(nSimsInput) ? 1000 : nSimsInput;

        updateAccumYears(); 

        const inputs = {
            btcInitial: getVal('startBtc'),
            cashInitial: getVal('startCash'),
            accumYears: getVal('accumYears'),
            retYear: getVal('retirementYear', 2030),
            preCagr: getVal('preCagr'),
            
            baseCagr: getVal('baseCagr'),
            decay: getVal('decay'),
            vol: getVal('volatility'),
            volDecay: getVal('volDecay'),
            cashInterest: getVal('cashInterest'),
            
            floorBase: getVal('floorPension'),
            idealBase: getVal('idealPension'),
            pensionGrowth: getVal('pensionGrowth'),
            wRatePct: getVal('safeCapPct'),
            
            simYears: getVal('simYears'),
            freezeThreshold: getVal('freezeThreshold'),
            useFreeze: document.getElementById('inflationFreeze') ? document.getElementById('inflationFreeze').checked : false,
            strategy: document.getElementById('strategyType').value,
            rule: document.getElementById('withdrawalRule').value
        };
        globalInputs = inputs;

        const totalMonths = inputs.simYears * 12;
        const dt = 1/12;
        
        // Start Values (Post-Accumulation)
        const btcStart = inputs.btcInitial * Math.pow(1 + inputs.preCagr, inputs.accumYears);
        const cashStart = inputs.cashInitial * Math.pow(1 + 0.03, inputs.accumYears);

        // State Arrays
        let simBtc = new Float64Array(nSims).fill(btcStart);
        let simCash = new Float64Array(nSims).fill(cashStart);
        let currentFloors = new Float64Array(nSims).fill(inputs.floorBase);
        let currentIdeals = new Float64Array(nSims).fill(inputs.idealBase);
        
        // Annual Rebalance Tracking
        let prevYearBtc = new Float64Array(nSims).fill(btcStart); 

        // Data for Charts/Tables
        let historyWealth = []; 
        let historyPension = []; 
        let historyBuffer = [];
        let yearlyTableData = [];
        let currentMonthPensions = new Float64Array(nSims);
        let yearlyPensionAccum = new Float64Array(nSims).fill(0);
        let floorHits = 0, idealHits = 0, monthsCounted = 0;

        const monthlyInterest = Math.pow(1 + inputs.cashInterest, 1/12);
        
        const stratFunc = Strategies[inputs.strategy];
        const ruleFunc = WithdrawalRules[inputs.rule];

        for (let m = 0; m < totalMonths; m++) {
            const yearIdx = Math.floor(m / 12);
            const isJan = (m % 12) === 0;

            // --- Annual Logic ---
            if (isJan) {
                if (yearIdx > 0) {
                    for (let i = 0; i < nSims; i++) {
                        let grow = 1.0 + inputs.pensionGrowth;
                        if (inputs.useFreeze && simCash[i] < inputs.freezeThreshold) grow = 1.0;
                        currentFloors[i] *= grow;
                        currentIdeals[i] *= grow;
                    }
                    
                    for (let i = 0; i < nSims; i++) {
                        const startVal = prevYearBtc[i];
                        const endVal = simBtc[i]; 
                        const yrReturn = (endVal / startVal) - 1;
                        
                        const rebalanceAmt = stratFunc.onYear(yrReturn, simBtc[i]);
                        if (rebalanceAmt > 0) {
                            simBtc[i] -= rebalanceAmt;
                            simCash[i] += rebalanceAmt;
                        }
                        prevYearBtc[i] = simBtc[i];
                    }
                    
                    yearlyPensionAccum.fill(0);
                } else {
                    prevYearBtc.fill(btcStart);
                }
            }

            const currentCagr = inputs.baseCagr * Math.pow(inputs.decay, yearIdx);
            const currentVol = inputs.vol * Math.pow(inputs.volDecay, yearIdx);
            const drift = Math.log(1 + currentCagr);
            const volTerm = currentVol * Math.sqrt(dt);

            for (let i = 0; i < nSims; i++) {
                let u1 = Math.random();
                let u2 = Math.random();
                let z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
                let growthFactor = Math.exp((drift * dt) + (volTerm * z));
                
                let oldBtc = simBtc[i];
                simBtc[i] *= growthFactor;
                simCash[i] *= monthlyInterest;
                
                const isPositive = simBtc[i] > oldBtc;
                const safeCap = simBtc[i] * inputs.wRatePct;
                const actualPension = ruleFunc(currentFloors[i], currentIdeals[i], safeCap);
                
                if (actualPension === currentFloors[i]) floorHits++;
                if (actualPension === currentIdeals[i]) idealHits++;
                
                const res = stratFunc.onMonth(isPositive, actualPension, simBtc[i], simCash[i]);
                
                simCash[i] -= res.paidFromCash;
                simCash[i] += res.skim;
                simBtc[i] -= (res.paidFromBtc + res.skim);
                
                if (simBtc[i] < 0) { simCash[i] += simBtc[i]; simBtc[i] = 0; }
                
                currentMonthPensions[i] = actualPension; 
                yearlyPensionAccum[i] += actualPension;
            }
            monthsCounted += nSims;

            if (m % 3 === 0 || m === totalMonths - 1) { 
                 let wealths = new Float64Array(nSims);
                 for(let k=0; k<nSims; k++) wealths[k] = simBtc[k] + simCash[k];
                 wealths.sort();
                 historyWealth.push({ m: m, p05: wealths[Math.floor(nSims*0.05)], p10: wealths[Math.floor(nSims*0.1)], p30: wealths[Math.floor(nSims*0.3)], p50: wealths[Math.floor(nSims*0.5)], p70: wealths[Math.floor(nSims*0.7)], p90: wealths[Math.floor(nSims*0.9)] });
                 
                 let cashes = new Float64Array(simCash);
                 cashes.sort();
                 historyBuffer.push({ m: m, p05: cashes[Math.floor(nSims*0.05)], p10: cashes[Math.floor(nSims*0.1)], p30: cashes[Math.floor(nSims*0.3)], p50: cashes[Math.floor(nSims*0.5)], p70: cashes[Math.floor(nSims*0.7)], p90: cashes[Math.floor(nSims*0.9)] });

                 let sortedPens = new Float64Array(currentMonthPensions);
                 sortedPens.sort();
                 historyPension.push({ m: m, p05: sortedPens[Math.floor(nSims*0.05)], p10: sortedPens[Math.floor(nSims*0.1)], p30: sortedPens[Math.floor(nSims*0.3)], p50: sortedPens[Math.floor(nSims*0.5)], p70: sortedPens[Math.floor(nSims*0.7)], p90: sortedPens[Math.floor(nSims*0.9)] });
            }
            
            if (m % 12 === 11) {
                let yearSnapshots = [];
                for(let k=0; k<nSims; k++) {
                    yearSnapshots.push({ w: simBtc[k] + simCash[k], b: simCash[k], p: yearlyPensionAccum[k] / 12.0 });
                }
                yearSnapshots.sort((a, b) => a.w - b.w);
                
                yearlyTableData.push({
                    year: inputs.retYear + yearIdx,
                    exUnlucky: yearSnapshots[Math.floor(nSims * 0.05)],
                    unlucky: yearSnapshots[Math.floor(nSims * 0.10)],
                    semiUnlucky: yearSnapshots[Math.floor(nSims * 0.30)],
                    median: yearSnapshots[Math.floor(nSims * 0.50)],
                    semiLucky: yearSnapshots[Math.floor(nSims * 0.70)],
                    lucky: yearSnapshots[Math.floor(nSims * 0.90)]
                });
            }
        }

        // Final KPIs
        let finalState = [];
        for(let i=0; i<nSims; i++) finalState.push({ val: simBtc[i] + simCash[i] });
        finalState.sort((a, b) => a.val - b.val);
        
        globalTableData = yearlyTableData;
        globalSimResults = {
            unlucky: finalState[Math.floor(nSims * 0.1)],
            survival: finalState.filter(w => w.val > 1000).length / nSims,
            medianMult: finalState[Math.floor(nSims * 0.5)].val / (btcStart + cashStart)
        };

        document.getElementById('statSurvival').innerText = (globalSimResults.survival * 100).toFixed(1) + "%";
        document.getElementById('statMedianWealth').innerText = globalSimResults.medianMult.toFixed(2) + "x";
        document.getElementById('statFloorHit').innerText = ((floorHits / monthsCounted) * 100).toFixed(1) + "%";
        document.getElementById('statUnluckyWealth').innerText = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'PLN', maximumFractionDigits: 0 }).format(globalSimResults.unlucky.val);

        renderTable();
        updateChart(historyWealth, historyPension, historyBuffer);
        updateCalculator();
    }

    // --- Table & Chart Rendering ---
    function renderTable() {
        if (!globalTableData || !globalInputs) return;
        const tbody = document.querySelector('#resultsTable tbody');
        const thead = document.querySelector('#resultsTable thead');
        tbody.innerHTML = '';
        
        const scenarios = [
            { key: 'exUnlucky', label: 'Extreme (5%)', cls: 'sc-ex-unlucky', show: document.getElementById('showExUnlucky').checked },
            { key: 'unlucky', label: 'Unlucky (10%)', cls: 'sc-unlucky', show: document.getElementById('showUnlucky').checked },
            { key: 'semiUnlucky', label: 'Semi (30%)', cls: 'sc-semi-unlucky', show: document.getElementById('showSemiUnlucky').checked },
            { key: 'median', label: 'Median (50%)', cls: 'sc-median', show: document.getElementById('showMedian').checked },
            { key: 'semiLucky', label: 'Semi (70%)', cls: 'sc-semi-lucky', show: document.getElementById('showSemiLucky').checked },
            { key: 'lucky', label: 'Lucky (90%)', cls: 'sc-lucky', show: document.getElementById('showLucky').checked }
        ];

        let headHTML = '<tr><th class="text-left">Year</th><th>Target Range</th>';
        scenarios.forEach(s => { if(s.show) { 
            headHTML += `<th class="${s.cls}">${s.label} Pension</th><th class="${s.cls}">${s.label} Buffer</th><th class="${s.cls}">${s.label} Wealth</th>`; 
        }});
        thead.innerHTML = headHTML + '</tr>';

        const growth = globalInputs.pensionGrowth;
        const fmt = (n) => new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(n);

        globalTableData.forEach(row => {
            const offset = row.year - globalInputs.retYear;
            const f = globalInputs.floorBase * Math.pow(1+growth, offset);
            const i = globalInputs.idealBase * Math.pow(1+growth, offset);
            
            let rowHTML = `<tr><td class="text-left font-bold">${row.year}</td><td class="text-gray-500 text-xs">${fmt(f)} - ${fmt(i)}</td>`;
            scenarios.forEach(s => {
                if (s.show) {
                    const d = row[s.key];
                    rowHTML += `<td class="${s.cls}">${fmt(d.p)}</td><td class="${s.cls}">${fmt(d.b)}</td><td class="${s.cls} font-bold">${fmt(d.w)}</td>`;
                }
            });
            tbody.innerHTML += rowHTML + '</tr>';
        });
    }

    // Restored updateChartVisibility logic
    function updateChartVisibility() {
        if (!window.currentChartData || !chartInstance) return;
        
        const visibility = {
            'Lucky (90%)': document.getElementById('chartShowLucky').checked,
            'Semi-Lucky (70%)': document.getElementById('chartShowSemiLucky').checked,
            'Median (50%)': document.getElementById('chartShowMedian').checked,
            'Semi-Unlucky (30%)': document.getElementById('chartShowSemiUnlucky').checked,
            'Unlucky (10%)': document.getElementById('chartShowUnlucky').checked,
            'Extreme (5%)': document.getElementById('chartShowExUnlucky').checked
        };

        chartInstance.data.datasets.forEach(ds => {
            if (visibility.hasOwnProperty(ds.label)) {
                ds.hidden = !visibility[ds.label];
            }
        });
        chartInstance.update();
    }

    function updateChart(wealthData, pensionData, bufferData) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        
        const labels = wealthData.map(d => (globalInputs.retYear + Math.floor(d.m/12)));
        const d = wealthData; 

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Lucky (90%)', borderColor: '#059669', borderWidth: 2, pointRadius: 0, fill: false, data: d.map(x=>x.p90) },
                    { label: 'Semi-Lucky (70%)', borderColor: '#7c3aed', borderWidth: 2, pointRadius: 0, fill: false, data: d.map(x=>x.p70) },
                    { label: 'Median (50%)', borderColor: '#2563eb', borderWidth: 3, pointRadius: 0, fill: false, data: d.map(x=>x.p50) },
                    { label: 'Semi-Unlucky (30%)', borderColor: '#d97706', borderWidth: 2, pointRadius: 0, fill: false, data: d.map(x=>x.p30) },
                    { label: 'Unlucky (10%)', borderColor: '#dc2626', borderWidth: 2, pointRadius: 0, borderDash: [5, 5], fill: false, data: d.map(x=>x.p10) },
                    { label: 'Extreme (5%)', borderColor: '#7f1d1d', borderWidth: 1, pointRadius: 0, borderDash: [2, 2], fill: false, data: d.map(x=>x.p05) }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: { y: { beginAtZero: true, ticks: { callback: v => v>=1000000 ? (v/1000000).toFixed(1)+'M' : (v/1000).toFixed(0)+'k' } } }
            }
        });
        window.currentChartData = { wealth: wealthData, pension: pensionData, buffer: bufferData };
        updateChartVisibility();
    }

    document.getElementById('freezeThreshold').addEventListener('input', (e) => {
        document.getElementById('freezeLabel').innerText = (e.target.value / 1000) + 'k';
    });

    updateStrategyDesc();
    updateWithdrawalDesc();
    runSimulation();

</script>
</body>
</html>
